<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Structure Viewer</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>📊 Structure Viewer</h1>
      </div>

      <div class="project-section">
        <h2>プロジェクト</h2>
        <div class="project-actions">
          <button id="newProjectBtn" class="btn btn-primary">
            <span class="icon">➕</span> 新規プロジェクト
          </button>
          <button id="openProjectBtn" class="btn btn-secondary">
            <span class="icon">📂</span> 開く
          </button>
          <button id="saveProjectBtn" class="btn btn-accent" disabled>
            <span class="icon">💾</span> 保存
          </button>
        </div>

        <div class="current-project">
          <h3>現在のプロジェクト</h3>
          <div id="currentProjectName" class="project-name">未選択</div>
        </div>

        <div class="recent-projects">
          <h3>最近のプロジェクト</h3>
          <div id="recentProjectsList" class="project-list">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>

      <div class="mode-section">
        <h2>モード</h2>
        <div class="mode-toggle">
          <button id="editModeBtn" class="mode-btn active">
            <span class="icon">✏️</span> 編集
          </button>
          <button id="viewModeBtn" class="mode-btn">
            <span class="icon">👁️</span> 閲覧
          </button>
        </div>
      </div>

      <div class="view-options-section" id="viewOptionsSection"
        style="display: none; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
        <h2 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">閲覧オプション</h2>

        <div class="option-group" style="margin-bottom: 15px;">
          <label
            style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">クリック時の動作</label>
          <div class="toggle-group" style="display: flex; gap: 5px;">
            <button id="clickActionFile" class="btn btn-secondary active"
              style="flex: 1; font-size: 11px; padding: 4px;">📄 開く</button>
            <button id="clickActionFolder" class="btn btn-secondary" style="flex: 1; font-size: 11px; padding: 4px;">📂
              場所</button>
          </div>
        </div>

        <div class="option-group">
          <label
            style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">プレビュー量</label>
          <div class="toggle-group" style="display: flex; gap: 5px;">
            <button id="previewPartial" class="btn btn-secondary active"
              style="flex: 1; font-size: 11px; padding: 4px;">📑 一部</button>
            <button id="previewFull" class="btn btn-secondary" style="flex: 1; font-size: 11px; padding: 4px;">📜
              全文</button>
          </div>
        </div>
      </div>

      <div class="info-section">
        <div id="statusInfo" class="status-info">
          準備完了
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="toolbar">
        <button id="uploadImageBtn" class="btn btn-primary">
          <span class="icon">🖼️</span> 構造図をアップロード
        </button>
        <button id="clearAreasBtn" class="btn btn-danger" style="display: none;">
          <span class="icon">🗑️</span> 全エリアクリア
        </button>
        <div id="bgColorControls" class="bg-color-control"
          style="margin-left: 10px; display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 12px; color: var(--text-secondary);">背景:</span>
          <button class="bg-color-btn" data-color="transparent" title="透過"
            style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #666; cursor: pointer; background-image: linear-gradient(45deg, #888 25%, transparent 25%), linear-gradient(-45deg, #888 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #888 75%), linear-gradient(-45deg, transparent 75%, #888 75%); background-size: 8px 8px; background-position: 0 0, 0 4px, 4px -4px, -4px 0px; background-color: #333; transition: transform 0.2s;"></button>
          <button class="bg-color-btn active" data-color="#ffffff" title="白"
            style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid #666; cursor: pointer; background-color: #ffffff; transition: transform 0.2s;"></button>
          <button class="bg-color-btn" data-color="#000000" title="黒"
            style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid #666; cursor: pointer; background-color: #000000; transition: transform 0.2s;"></button>
          <button class="bg-color-btn" data-color="#00ff00" title="緑"
            style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid #666; cursor: pointer; background-color: #00ff00; transition: transform 0.2s;"></button>
          <button class="bg-color-btn" data-color="#ff0000" title="赤"
            style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid #666; cursor: pointer; background-color: #ff0000; transition: transform 0.2s;"></button>
          <button class="bg-color-btn" data-color="#0000ff" title="青"
            style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid #666; cursor: pointer; background-color: #0000ff; transition: transform 0.2s;"></button>
          <button class="bg-color-btn" data-color="#ffff00" title="黄"
            style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid #666; cursor: pointer; background-color: #ffff00; transition: transform 0.2s;"></button>
          <button class="bg-color-btn" data-color="#800080" title="紫"
            style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid #666; cursor: pointer; background-color: #800080; transition: transform 0.2s;"></button>
          <button class="bg-color-btn" data-color="#ffa500" title="橙"
            style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid #666; cursor: pointer; background-color: #ffa500; transition: transform 0.2s;"></button>
        </div>
        <div class="toolbar-info">
          <span id="areaCount">エリア数: 0</span>
        </div>
      </div>

      <div class="canvas-container" id="canvasContainer">
        <canvas id="mainCanvas"></canvas>
        <div id="selectionBox" class="selection-box"></div>
        <div id="editHandles" class="edit-handles"></div>
      </div>

      <div class="instructions" id="instructions">
        <h2>使い方</h2>
        <ol>
          <li>「構造図をアップロード」ボタンでシステム構造図の画像を読み込みます</li>
          <li>編集モードで画像上をドラッグしてエリアを作成します</li>
          <li>作成したエリアをクリックしてファイルやURLを紐付けます</li>
          <li>閲覧モードでエリアにホバーするとプレビューが表示されます</li>
          <li>プロジェクトを保存して後から読み込むことができます</li>
        </ol>
      </div>
    </main>
  </div>

  <!-- File Association Modal -->
  <div id="fileAssociationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ファイル・リンクを設定</h2>
        <button class="close-btn" id="closeModalBtn">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="areaLabel">ラベル</label>
          <input type="text" id="areaLabel" placeholder="_(:3」∠)_" class="input-field">
          <div class="checkbox-container" style="margin-top: 8px; display: flex; align-items: center; gap: 6px;">
            <input type="checkbox" id="autoLabelCheck">
            <label for="autoLabelCheck"
              style="display:inline; color:var(--text-secondary); font-size:13px; margin:0; cursor:pointer;">選択したファイル名を名前にする</label>
          </div>
        </div>

        <div class="form-group">
          <label>種類</label>
          <div class="type-selector">
            <button class="type-btn active" data-type="file">📄 ファイル</button>
            <button class="type-btn" data-type="url">🌐 URL</button>
          </div>
        </div>

        <div class="form-group" id="fileInputGroup">
          <label for="filePath">ファイルパス</label>
          <div class="file-path-input">
            <input type="text" id="filePath" placeholder="ファイルまたはフォルダを選択..." class="input-field" readonly>
            <div style="display: flex; gap: 4px;">
              <button id="browseFileBtn" class="btn btn-secondary" style="white-space: nowrap;">ファイル参照</button>
              <button id="browseFolderBtn" class="btn btn-secondary" style="white-space: nowrap;">フォルダ参照</button>
            </div>
          </div>
        </div>

        <div class="form-group" id="urlInputGroup" style="display: none;">
          <label for="urlPath">URL</label>
          <input type="text" id="urlPath" placeholder="https://example.com" class="input-field">
        </div>
      </div>
      <div class="modal-footer">
        <button id="deleteAreaBtn" class="btn btn-danger">削除</button>
        <button id="saveAssociationBtn" class="btn btn-primary">保存</button>
      </div>
    </div>
  </div>

  <!-- Project Name Modal -->
  <div id="projectNameModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>新規プロジェクト</h2>
        <button class="close-btn" id="closeProjectModalBtn">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="projectNameInput">プロジェクト名</label>
          <input type="text" id="projectNameInput" placeholder="_(:3」∠)_" class="input-field" autofocus>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelProjectBtn" class="btn btn-secondary">キャンセル</button>
        <button id="createProjectBtn" class="btn btn-primary">作成</button>
      </div>
    </div>
  </div>

  <!-- Project List Modal -->
  <div id="projectListModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>プロジェクトを開く</h2>
        <button class="close-btn" id="closeProjectListBtn">✕</button>
      </div>
      <div class="modal-body">
        <div id="projectListContainer" class="project-list-container">
          <!-- Dynamically populated -->
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Popup -->
  <div id="previewPopup" class="preview-popup">
    <div class="preview-header">
      <span id="previewTitle">Loading...</span>
    </div>
    <div id="previewContent" class="preview-content">
      <!-- Dynamically populated -->
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script src="js/app.js"></script>
  <!-- Alert Modal -->
  <div id="alertModal" class="modal" style="z-index: 20002;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <div class="modal-header" style="justify-content: center; border-bottom: none; padding-bottom: 0;">
        <h2 id="alertTitle" style="color: var(--text-primary); margin: 0;">Notice</h2>
      </div>
      <div class="modal-body">
        <p id="alertMessage" style="color: var(--text-secondary); margin-bottom: 20px; font-size: 15px;"></p>
        <button id="alertOkBtn" class="btn btn-primary" style="min-width: 100px;">OK</button>
      </div>
    </div>
  </div>

  <script src="js/canvas.js"></script>
  <script src="js/file-handler.js"></script>
  <script src="js/preview.js"></script>